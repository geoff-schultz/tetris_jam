<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="https://code.jquery.com/jquery-3.4.1.js" integrity="sha256-WpOohJOqMqqyKL9FccASB9O0KwACQJpFTUBLTYOVvVU=" crossorigin="anonymous"></script>
    <title>Tetris</title>
</head>
<style>
    * {
        padding: 0;
        margin: 0;
    }
    #playarea {
        background-color: rgb(20, 20, 20);
        border: 3px solid grey;
        border-radius: 10px;
        display: inline-block;
    }
    .square {
        border: 1px solid rgb(20, 20, 20);
        border-radius: 3px;
        display: inline-block;
        width: 2em;
        height: 2em;
    }
    .block0 {
        background-color: black;
    }

    .block1 {
        background-color: red;
    }

    .block2 {
        background-color: yellow;
    }

    .block3 {
        background-color: purple;
    }

    .block4 {
        background-color: green;
    }

    .block5 {
        background-color: blue;
    }

    .block6 {
        background-color: white;
    }

    .block7 {
        background-color: yellowgreen;
    }
</style>
<body>
    <h1>Tetris Jam</h1>
    <div id="playarea">
    </div>    
</body>
<script>

    class Block {
        currentPosition;
        blockType;

        constructor(blockType){
            this.blockType = blockType;
            this.currentPosition = this.blockTypes[this.blockType]["pattern"];
            this.currentPosition.forEach((i)=>{
                   if(playAreaArray[i[0]][i[1]] != 0){
                       console.log("RIP Game Over")
                       clearInterval(runtime);
                   }
            })
            this.drawBlock()
        }

        blockTypes = [
            null,
            {"name": "iBlock", "pattern": [[0,4],[1,4],[2,4],[3,4]]},
            {"name": "rlBlock", "pattern": [[0,4],[1,4],[2,4],[2,5]]},
            {"name": "llBlock", "pattern": [[0,4],[1,4],[2,4],[2,3]]},
            {"name": "sqBlock", "pattern": [[0,4],[0,5],[1,4],[1,5]]},
            {"name": "rsBlock", "pattern": [[0,4],[1,4],[1,5],[2,5]]},
            {"name": "lsBlock", "pattern": [[0,5],[1,5],[1,4],[2,4]]},
            {"name": "tBlock", "pattern": [[0,4],[0,5],[0,6],[1,5]]},
        ]

        drawBlock() {
            this.currentPosition.forEach((b)=>{
                playAreaArray[b[0]][b[1]] = this.blockType;
            })
        }

        rotateBlock(){
            let newPosition;
            let cp = this.currentPosition
            console.log(this.blockType)
            switch(this.blockType){
                case 1:
                    if(cp[0][1] == cp[1][1]){
                        newPosition = [[cp[2][0],cp[2][1]-2], [cp[2][0],cp[2][1]-1], [cp[2][0],cp[2][1]], [cp[2][0],cp[2][1]+1]];
                    }
                    else {
                        newPosition = [[cp[2][0]-2,cp[2][1]], [cp[2][0]-1,cp[2][1]], [cp[2][0],cp[2][1]], [cp[2][0]+1,cp[2][1]]];
                    }
                    break;
                case 2:
                    if(cp[0][0] < cp[1][0]){
                        newPosition = [[cp[1][0],cp[1][1]+1], [cp[1][0],cp[1][1]], [cp[1][0],cp[1][1]-1], [cp[1][0]+1,cp[1][1]-1]];
                    }
                    else if(cp[0][1] > cp[1][1]){
                        newPosition = [[cp[1][0]+1,cp[1][1]], [cp[1][0],cp[1][1]], [cp[1][0]-1,cp[1][1]], [cp[1][0]-1,cp[1][1]-1]];
                    }
                    else if(cp[0][0] > cp[1][0]){
                        newPosition = [[cp[1][0],cp[1][1]-1], [cp[1][0],cp[1][1]], [cp[1][0],cp[1][1]+1], [cp[1][0]-1,cp[1][1]+1]];
                    }
                    else {
                        newPosition = [[cp[1][0]-1,cp[1][1]], [cp[1][0],cp[1][1]], [cp[1][0]+1,cp[1][1]], [cp[1][0]+1,cp[1][1]+1]];
                    }
                    break;
                case 3:
                    if(cp[0][0] < cp[1][0]){
                        newPosition = [[cp[1][0],cp[1][1]+1], [cp[1][0],cp[1][1]], [cp[1][0],cp[1][1]-1], [cp[1][0]-1,cp[1][1]-1]];
                    }
                    else if(cp[0][1] > cp[1][1]){
                        newPosition = [[cp[1][0]+1,cp[1][1]], [cp[1][0],cp[1][1]], [cp[1][0]-1,cp[1][1]], [cp[1][0]-1,cp[1][1]+1]];
                    }
                    else if(cp[0][0] > cp[1][0]){
                        newPosition = [[cp[1][0],cp[1][1]-1], [cp[1][0],cp[1][1]], [cp[1][0],cp[1][1]+1], [cp[1][0]+1,cp[1][1]+1]];
                    }
                    else {
                        newPosition = [[cp[1][0]-1,cp[1][1]], [cp[1][0],cp[1][1]], [cp[1][0]+1,cp[1][1]], [cp[1][0]+1,cp[1][1]-1]];
                    }
                    break;
                case 4:
                    newPosition = [[cp[0][0],cp[0][1]], [cp[1][0],cp[1][1]], [cp[2][0],cp[2][1]], [cp[3][0],cp[3][1]]];
                    break;
                case 5:
                    if(cp[0][1] == cp[1][1]){
                        newPosition = [[cp[1][0],cp[1][1]+1], [cp[1][0],cp[1][1]], [cp[1][0]+1,cp[1][1]], [cp[1][0]+1,cp[1][1]-1]];
                    }
                    else {
                        newPosition = [[cp[1][0]-1,cp[1][1]], [cp[1][0],cp[1][1]], [cp[1][0],cp[1][1]+1], [cp[1][0]+1,cp[1][1]+1]];
                    }
                    break;
                case 6:
                    if(cp[0][1] == cp[1][1]){
                        newPosition = [[cp[1][0],cp[1][1]-1], [cp[1][0],cp[1][1]], [cp[1][0]+1,cp[1][1]], [cp[1][0]+1,cp[1][1]+1]];
                    }
                    else {
                        newPosition = [[cp[1][0]-1,cp[1][1]], [cp[1][0],cp[1][1]], [cp[1][0],cp[1][1]-1], [cp[1][0]+1,cp[1][1]-1]];
                    }
                    break;
                case 7:
                    if(cp[1][0] < cp[3][0]){
                        newPosition = [[cp[1][0]-1,cp[1][1]], [cp[1][0],cp[1][1]], [cp[1][0]+1,cp[1][1]], [cp[1][0],cp[1][1]-1]];
                    }
                    else if(cp[1][1] > cp[3][1]){
                        newPosition = [[cp[1][0],cp[1][1]-1], [cp[1][0],cp[1][1]], [cp[1][0],cp[1][1]+1], [cp[1][0]-1,cp[1][1]]];
                    }
                    else if(cp[1][0] > cp[3][0]){
                        newPosition = [[cp[1][0]+1,cp[1][1]], [cp[1][0],cp[1][1]], [cp[1][0]-1,cp[1][1]], [cp[1][0],cp[1][1]+1]];
                    }
                    else {
                        newPosition = [[cp[1][0],cp[1][1]-1], [cp[1][0],cp[1][1]], [cp[1][0],cp[1][1]+1], [cp[1][0]+1,cp[1][1]]];
                    }
                    break;
                }
            if(this.checkNewPosition(newPosition)){
                this.updatePosition(newPosition);
            }
        }

        move(direction){
            let newPosition = []
            this.currentPosition.forEach((row, i)=>{
                newPosition.push([])
                row.forEach((col, j)=>{
                    newPosition[i].push(col)
                })
            })

            for(let i = 0; i < this.currentPosition.length; i++){
                    newPosition[i][1] += direction;
                }

            if(this.checkNewPosition(newPosition)){
                this.updatePosition(newPosition);
            }            
        }

        dropBlock() {
            let newPosition = []
            this.currentPosition.forEach((row, i)=>{
                newPosition.push([])
                row.forEach((col, j)=>{
                    newPosition[i].push(col)
                })
            })

            for(let i = 0; i < this.currentPosition.length; i++){
                    newPosition[i][0] += 1;
                }

            if(this.checkNewPosition(newPosition)){
                this.updatePosition(newPosition);
                return true;
            }
            else {
                return false;
            }
        }

        checkNewPosition(newPosition) {
            let oldPosition = []
            this.currentPosition.forEach((row, i)=>{
                oldPosition.push([])
                row.forEach((col, j)=>{
                    oldPosition[i].push(col)
                })
            })

            for(let i = 0; i < this.currentPosition.length; i++){
                playAreaArray[oldPosition[i][0]][oldPosition[i][1]] = 0;
                if(newPosition[i][0] > 19 || newPosition[i][0] < 0){
                    this.drawBlock()
                    return false;
                }
            }

            for(let i = 0; i < newPosition.length; i++){
                if(playAreaArray[newPosition[i][0]][newPosition[i][1]] !== 0){
                    this.drawBlock()
                    return false;
                }
            }
            return true;
        }

        updatePosition(newPosition) {            
            this.currentPosition.forEach((row, i)=>{
                row.forEach((col, j)=>{
                    this.currentPosition[i][j] = newPosition[i][j]
                })
            })
            this.drawBlock()
            renderPlayArea();
        }

    }
    


    //variables:
    let playAreaArray = [];
    let columns = "abcdefghij"



    //functions:
    function buildPlayArea(){
        playAreaArray = [];
        for(let i = 0; i < 20; i++){
            playAreaArray.push([])
            $("#playarea").append(`<div class=row>`)
            for(let j = 0; j < 10; j++){
                playAreaArray[i].push(0)
                $("#playarea").append(`<div class="square block0">&nbsp;</div>`)
            }
            $("#playarea").append(`</div>`)
        }

    }


    function renderPlayArea(){
        $("#playarea").html("")
        playAreaArray.forEach((row, rInd)=>{
            $("#playarea").append(`<div class=row>`)
            row.forEach((col, cInd)=>{
                $("#playarea").append(`<div class="square block${col}">&nbsp;</div>`)
            })
            $("#playarea").append(`</div>`)
        })
    }

    function checkFullRows(){
        playAreaArray.forEach((row, i)=>{
            if(row.find((b)=> b == 0) == undefined){
                playAreaArray.splice(i,1)
                playAreaArray.unshift([[0],[0],[0],[0],[0],[0],[0],[0],[0],[0]])
            }
                renderPlayArea();
        })
    }

    function gameover(){
        clearInterval();
    }

    function gameLoop(){
        let result = aBlock.dropBlock();
        if(result == false){
            checkFullRows()
            aBlock = new Block(Math.floor(Math.random()*7+1))
        }
        renderPlayArea();
    }

    //function calls and runtime



    $(document).ready(()=>{
        buildPlayArea();
        aBlock = new Block(Math.floor(Math.random()*7+1))
        renderPlayArea();
        runtime = setInterval(gameLoop, 500)
        document.addEventListener("keydown", function(event){
            // console.log("PRESSED", event.keyCode)
            switch(event.keyCode){
                case 32:
                    aBlock.rotateBlock();
                    break;
                case 37:
                    aBlock.move(-1)
                    break;
                case 39:
                    aBlock.move(1)
                    break;
                case 40:
                    aBlock.dropBlock()
                    break;
            }

        });
        
    })
</script>
</html>